<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoría de Picking</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la biblioteca para escanear QR/códigos de barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" xintegrity="sha512-r6rL1TIIFRBcK7mB/G/R/vNzx0vXEOy/N0PNHvKMIUvAUlSAgP/gfb/T5A/L/m+LbpLWoI2C/a/CSJtMrjVd/A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Carga de la biblioteca para parsear CSV (PapaParse) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" xintegrity="sha512-dfbSBCFEJQG0evQ2/MdVf/DuObpMVPaT8FfX4UvhTfTqYmv/vuFwS4Lz0VqD_S/vQhZ+3E/pS/cmhMhK/N2S/A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Carga de la biblioteca para sonidos (Tone.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js" xintegrity="sha512-S/v27I/vR/wI/vT4QGKJ1bcrPd/pQHYa1Kjln9qKqKG46tWp1/cvcGoR/Ag03T/oFzX/cI/Oa/v/Q/9S/0fJ/Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Estilo para la fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ocultar el 'spinner' de los inputs numéricos */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }
        /* Estilo para el lector de QR */
        #qr-reader {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor Principal -->
    <div class="container mx-auto max-w-4xl p-4 md:p-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">Chequeo de picking</h1>
        </header>

        <!-- Sección 1: Carga de Pedido -->
        <section id="load-section" class="mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="order-number" class="block text-sm font-medium text-gray-700">Order Number</label>
                    <input type="text" id="order-number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 0043677">
                </div>
                <div>
                    <label for="despatch-number" class="block text-sm font-medium text-gray-700">Despatch Number</label>
                    <input type="text" id="despatch-number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 01">
                </div>
            </div>

            <button id="load-order-btn" class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Cargar Pedido
            </button>
        </section>

            <!-- Sección 2: Auditoría (Oculta por defecto) -->
            <section id="audit-section" class="hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-2">Auditoría del Pedido</h2>
                    <p class="text-lg">Cliente: <span id="customer-name" class="font-bold text-blue-700"></span></p>
                </div>

                <!-- Escáner y Lista de Items -->
                <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                    <div id="scanner-container" class="hidden">
                        <div id="qr-reader" class="w-full aspect-square max-h-[103px] mx-auto"></div>
                        <div class="flex gap-2 mt-4">
                            <button id="start-scanner-btn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-green-600">Iniciar Escáner</button>
                            <button id="stop-scanner-btn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-gray-600 hidden">Detener</button>
                        </div>
                    </div>
                    <div>
                        <label for="itemCode" class="form-label">ITEM CODE:</label>
                        <div class="flex items-end gap-2">
                            <input type="text" id="itemCode" name="itemCode" class="flex-grow" placeholder="Escanee el código o ingrese el item" oninput="this.value = this.value.toUpperCase()" required />
                            <button type="button" id="scanItemBtn" title="Escanear código de barras" class="btn-secondary h-9 w-auto px-3 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-qr-code-scan" viewBox="0 0 16 16">
                                <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5M.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5M4 4h1v1H4z"/>
                                <path d="M7 2H2v5h5zM3 3h3v3H3zm2 8H4v1h1z"/>
                                <path d="M7 9H2v5h5zm-4 1h3v3H3zm8-6h1v1h-1z"/>
                                <path d="M9 2h5v5H9zm1 1v3h3V3zM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8zm2 2H9V9h1zm4 2h-1v1h-2v1h3zm-4 2v-1H8v1z"/>
                                <path d="M12 9h2V8h-2z"/>
                                </svg>
                            </button>
                            <button type="button" id="findItemBtn" class="bg-gray-500 text-white py-2 px-4 rounded-md font-semibold shadow-sm hover:bg-gray-600"><span>Buscar</span></button>
                        </div>
                    </div>
                

                <!-- Columna Derecha: Lista de Items -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">3. Lista de Items</h2>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ITEM CODE</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DESCRIPCIÓN</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">REQ.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SCAN.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DIF.</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Filas de items se insertarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            

                    <!-- Acciones Finales -->
                    <div class="mt-6 flex flex-col md:flex-row gap-4">
                        <button id="finalize-btn" class="w-full md:w-auto flex-1 bg-green-500 text-white py-3 px-6 rounded-md font-semibold shadow-sm hover:bg-green-600 text-lg">
                            Finalizar Auditoría
                        </button>
                        <button id="reset-btn" class="w-full md:w-auto bg-gray-200 text-gray-700 py-3 px-6 rounded-md font-semibold hover:bg-gray-300">
                            Cargar Otro Pedido
                        </button>
                    </div>
        </section>
    </div>

    <!-- Contenedor de Mensajes (Toast) -->
    <div id="message-box" class="fixed top-5 right-5 z-50 p-4 rounded-md text-white font-semibold shadow-lg transition-all duration-300 opacity-0 translate-x-10 hidden">
        <span id="message-text"></span>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-xl font-bold text-yellow-600 mb-4">Confirmar Finalización</h3>
            <p class="text-gray-700 mb-6">Se detectaron diferencias en el picking (faltantes o sobrantes). ¿Desea guardar y finalizar la auditoría de todos modos?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-modal-btn" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300">Cancelar</ar>
                <button id="confirm-modal-btn" class="py-2 px-4 bg-yellow-500 text-white rounded-md font-semibold hover:bg-yellow-600">Confirmar y Guardar</button>
            </div>
        </div>
    </div>


    <script>
        // --- Variables Globales ---
        let orderItems = [];
        let customerName = "";
        let html5QrCode;
        let soundBeep, soundBoop;

        // --- Selectores del DOM ---
        const loadSection = document.getElementById('load-section');
        const auditSection = document.getElementById('audit-section');
        const loadOrderBtn = document.getElementById('load-order-btn');
        const orderNumberInput = document.getElementById('order-number');
        const despatchNumberInput = document.getElementById('despatch-number');
        const customerNameEl = document.getElementById('customer-name');
        const itemsTableBody = document.getElementById('items-table-body');
        const itemCodeInput = document.getElementById('itemCode');
        const scanItemBtn = document.getElementById('scanItemBtn');
        const findItemBtn = document.getElementById('findItemBtn');
        const finalizeBtn = document.getElementById('finalize-btn');
        const resetBtn = document.getElementById('reset-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const confirmationModal = document.getElementById('confirmation-modal');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const confirmModalBtn = document.getElementById('confirm-modal-btn');

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el objeto del escáner
            html5QrCode = new Html5Qrcode("qr-reader");

            // Inicializar sonidos (sólo si Tone.js se cargó)
            try {
                soundBeep = new Tone.Synth().toDestination();
                soundBoop = new Tone.Synth({ oscillator: { type: "square" } }).toDestination();
            } catch (e) {
                console.warn("Tone.js no se pudo inicializar. Los sonidos estarán desactivados.");
                // Crear objetos 'dummy' para evitar errores
                soundBeep = { triggerAttackRelease: () => {} };
                soundBoop = { triggerAttackRelease: () => {} };
            }
        });

        // --- Event Listeners ---
        loadOrderBtn.addEventListener('click', loadOrder);
        scanItemBtn.addEventListener('click', () => {
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.classList.toggle('hidden');
            if (!scannerContainer.classList.contains('hidden')) {
                startScanner();
            }
        });
        stopScannerBtn.addEventListener('click', stopScanner);
        findItemBtn.addEventListener('click', () => processScan(itemCodeInput.value));
        itemCodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); processScan(itemCodeInput.value); } });
        finalizeBtn.addEventListener('click', finalizeAudit);
        resetBtn.addEventListener('click', resetApp);
        cancelModalBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        confirmModalBtn.addEventListener('click', confirmFinalizeWithDifferences);

        // --- Funciones Principales ---

        /**
         * Carga y parsea el archivo CSV, filtra el pedido y prepara la UI de auditoría.
         */
        async function loadOrder() {
            const orderNum = orderNumberInput.value.trim();
            const despatchNum = despatchNumberInput.value.trim();

            if (!orderNum || !despatchNum) {
                showMessage("Por favor, ingrese 'Order Number' y 'Despatch Number'.", "error");
                return;
            }

            try {
                const response = await fetch(`/api/picking/order/${orderNum}/${despatchNum}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Error al cargar el pedido.");
                }

                const filteredItems = await response.json();

                if (filteredItems.length === 0) {
                    showMessage("Pedido no encontrado. Verifique los números.", "error");
                    return;
                }

                // Procesar los items encontrados
                orderItems = filteredItems.map(item => ({
                    code: item["Item Code"] ? item["Item Code"].trim() : '',
                    description: item["Item Description"] ? item["Item Description"].trim() : 'Sin descripción',
                    qty_req: parseInt(item["Qty"], 10) || 0,
                    qty_scan: 0
                }));

                customerName = filteredItems[0]["Customer Name"] || "N/A";
                customerNameEl.textContent = customerName;

                // Actualizar la UI
                updateTable();
                loadSection.classList.add('hidden');
                auditSection.classList.remove('hidden');
                showMessage(`Pedido ${orderNum}/${despatchNum} cargado. Listo para escanear.`, "success");

            } catch (e) {
                showMessage(e.message, "error");
                console.error(e);
            }
        }

        /**
         * Actualiza la tabla de items con los datos actuales de 'orderItems'.
         */
        function updateTable() {
            const itemsTableBody = document.getElementById('items-table-body');
            itemsTableBody.innerHTML = '';
            let allComplete = true;

            if (orderItems.length === 0) return;

            orderItems.forEach((item, index) => {
                const diff = item.qty_scan - item.qty_req;
                let rowClass = 'bg-white';
                let diffClass = 'text-gray-700';

                if (diff === 0 && item.qty_scan > 0) {
                    rowClass = 'bg-green-100'; // Completo
                    diffClass = 'text-green-700 font-bold';
                } else if (diff < 0 && item.qty_scan > 0) {
                    rowClass = 'bg-yellow-100'; // Parcial
                    diffClass = 'text-yellow-700 font-bold';
                } else if (diff > 0) {
                    rowClass = 'bg-red-100'; // Sobrante
                    diffClass = 'text-red-700 font-bold';
                }
                
                if (diff !== 0) {
                    allComplete = false;
                }

                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.code}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${item.description}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-blue-700">${item.qty_req}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold">
                        <input type="number" value="${item.qty_scan}" class="w-20 text-center border border-gray-300 rounded-md" data-index="${index}">
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${diffClass}">${diff}</td>
                `;
                itemsTableBody.appendChild(row);
            });

            // Add event listeners to the new input fields
            itemsTableBody.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const newQty = parseInt(e.target.value, 10);
                    if (!isNaN(newQty)) {
                        orderItems[index].qty_scan = newQty;
                        updateTable();
                    }
                });
            });

            // Si todo está completo, mostrar mensaje y detener escáner
            if (allComplete) {
                showMessage("¡Picking Completo! Todos los items verificados.", "success");
                stopScanner();
            }
        }

        /**
         * Inicia la cámara para escanear.
         */
        function startScanner() {
            // Configuración del escáner
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                rememberLastUsedCamera: true,
                supportedScanTypes: [
                    Html5QrcodeScanType.SCAN_TYPE_CAMERA
                ]
            };

            // Función de éxito
            const onScanSuccess = (decodedText, decodedResult) => {
                processScan(decodedText);
            };

            // Función de fallo (opcional, para debug)
            const onScanFailure = (error) => {
                // console.warn(`Scan error: ${error}`);
            };

            // Iniciar escáner
            html5QrCode.start(
                { facingMode: "environment" }, // Pedir cámara trasera
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                const startScannerBtn = document.getElementById('start-scanner-btn');
                const stopScannerBtn = document.getElementById('stop-scanner-btn');
                startScannerBtn.classList.add('hidden');
                stopScannerBtn.classList.remove('hidden');
                showMessage("Cámara iniciada. Apunte al código.", "info");
            }).catch(err => {
                showMessage("Error al iniciar la cámara. Verifique permisos.", "error");
                console.error(err);
            });
        }

        /**
         * Detiene el escáner de la cámara.
         */
        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop()
                    .then(() => {
                        const scannerContainer = document.getElementById('scanner-container');
                        scannerContainer.classList.add('hidden');
                        showMessage("Escáner detenido.", "info");
                    })
                    .catch(err => {
                        console.error("Error al detener el escáner:", err);
                    });
            }
        }

        /**
         * Procesa un código escaneado (de cámara o manual).
         */
        function processScan(scannedCode) {
            if (!scannedCode || scannedCode.trim() === '') return;
            
            scannedCode = scannedCode.trim();
            const item = orderItems.find(i => i.code === scannedCode);

            if (item) {
                item.qty_scan++;
                soundBeep.triggerAttackRelease("C5", "0.1"); // Sonido agudo OK
                showMessage(`OK: ${item.description}`, "success");
            } else {
                soundBoop.triggerAttackRelease("C3", "0.2"); // Sonido grave ERROR
                showMessage(`ERROR: Item incorrecto (${scannedCode})`, "error");
            }

            itemCodeInput.value = ''; // Limpiar input manual
            updateTable();
        }

        /**
         * Finaliza la auditoría. Comprueba diferencias.
         */
        function finalizeAudit() {
            const differencesExist = orderItems.some(item => item.qty_scan !== item.qty_req);

            if (differencesExist) {
                // Hay diferencias, mostrar modal de confirmación
                confirmationModal.classList.remove('hidden');
            } else {
                // Todo OK
                showMessage("¡Auditoría Finalizada! Picking OK.", "success", 5000);
                resetApp();
            }
        }

        /**
         * Se llama si el usuario confirma guardar con diferencias.
         */
        function confirmFinalizeWithDifferences() {
            confirmationModal.classList.add('hidden');
            showMessage("Auditoría finalizada y guardada con diferencias.", "warning", 5000);
            // Aquí iría la lógica para guardar los datos (ej. enviar a un servidor)
            console.log("Datos guardados con diferencias:", orderItems);
            resetApp();
        }

        /**
         * Resetea la aplicación a su estado inicial.
         */
        function resetApp() {
            stopScanner();
            orderItems = [];
            customerName = "";
            customerNameEl.textContent = "";
            itemsTableBody.innerHTML = '';
            orderNumberInput.value = '';
            despatchNumberInput.value = '';
            csvFileInput.value = null; // Limpiar el input de archivo

            auditSection.classList.add('hidden');
            loadSection.classList.remove('hidden');
            confirmationModal.classList.add('hidden');
        }

        /**
         * Muestra un mensaje temporal (toast) en pantalla.
         */
        function showMessage(message, type = "info", duration = 3000) {
            messageText.textContent = message;
            
            // Quitar clases de color anteriores
            messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'opacity-0', 'translate-x-10', 'hidden');

            // Añadir clase de color según el tipo
            switch (type) {
                case "success":
                    messageBox.classList.add('bg-green-500');
                    break;
                case "error":
                    messageBox.classList.add('bg-red-500');
                    break;
                case "warning":
                    messageBox.classList.add('bg-yellow-500');
                    break;
                default:
                    messageBox.classList.add('bg-blue-500');
            }
            
            // Mostrar
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.remove('opacity-0', 'translate-x-10');
            }, 10); // Pequeño delay para que la transición de entrada funcione

            // Ocultar después de la duración
            setTimeout(() => {
                messageBox.classList.add('opacity-0', 'translate-x-10');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Esperar que termine la transición de salida
            }, duration);
        }

    </script>

</body>
</html>
